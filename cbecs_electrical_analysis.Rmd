---
title: "cbecs_electrical_analysis"
author: "John Grando"
date: "February 11, 2019"
output: html_document
---

Source files
```{r}
source('cbecs_2012_clean_transform.R')
```

Libraries
```{r}
library(gridExtra)
library(factoextra)
library(pls)
library(randomForest)
library(inTrees)
library(doParallel)
library(doMC)
library(elasticnet)
library(keras)
library(tibble)
library(RSNNS)
library(car)
library(nnet)
```

#ploting funcitons
```{r}
plot_fun <- function(in_model=NA, n_features=2, short_name=NA, alt_predict=FALSE) {
  plot_df <- varImp(in_model)$importance %>% 
    rownames_to_column(var='feature') %>% 
    arrange(desc(Overall)) %>% 
    head(n_features)
  p1 <- ggplot(data = data.frame(plot_df), aes(x=reorder(feature, desc(Overall)), y=Overall)) + 
    geom_bar(stat='identity')
  ggsave(paste0('Documents/Images/electricity_',short_name,'_vars.png'), p1, width = 6.5, height = 2.75, units = 'in')

  imp_df <- plot_df %>% 
    select(feature)
  
  if(alt_predict==FALSE){
    tmp_model <- lm(predict(in_model$finalModel, cbecs_elbtu_encoded_center_scale_train_df) ~ 
      cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf)
  }
  if(alt_predict!=FALSE){
    tmp_model <- lm(predict(in_model, cbecs_elbtu_encoded_center_scale_train_df) ~ 
      cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf)
  }
  plot(tmp_model)
  png(paste0('Documents/Images/electricity_',short_name,'_res.png'), width = 6.5, height = 5, 
      units = 'in', pointsize = 12,
      bg='white', res=100)
  par(mfrow=c(2,2))
  plot(tmp_model)
  dev.off()
  par(mfrow=c(2,2))
  return(list(vars_plot = p1, 
              tmp_model = tmp_model,
              imp_df = imp_df)
  )
}
```

#Initialize parallel processing on 2 cores
```{r}
cl <- makePSOCKcluster(5)
registerDoParallel(cl)
```

Load and transform
```{r}
cbecs_raw_df <- read.csv('./2012_public_use_data_aug2016.csv', 
                         header = TRUE, 
                         stringsAsFactors = FALSE)
cbecs_dfs <- clean_encode_cbecs(cbecs_raw_df)
```

### Explore

```{r}
#remove buildings that know the don't use electricity
cbecs_el_encoded_df <- cbecs_dfs$encoded_df %>% 
  filter(ELUSED.1==1)
cbecs_el_cleaned_df <- cbecs_dfs$clean_df %>% 
  filter(ELUSED==1)
```

Response Variable
```{r}
ggplot(cbecs_el_cleaned_df, aes(x=ELBTUPerSf)) + 
  geom_density()
ggsave('Documents/Images/electricity_response.png', width = 6.5, height = 3, units = 'in')
lmbda <- BoxCoxTrans(cbecs_el_cleaned_df$ELBTUPerSf + 1)$lambda
ggplot(cbecs_el_cleaned_df, aes(x=ELBTUPerSf^lmbda)) + 
  geom_density() + 
  stat_function(fun=dnorm,
                color="blue",
                args=list(
                  mean=mean(cbecs_dfs$clean_df$ELBTUPerSf^lmbda, na.rm = TRUE),
                  sd(cbecs_dfs$clean_df$ELBTUPerSf^lmbda, na.rm = TRUE)
                )
  ) +
  ggtitle(paste('ELBTUPerSf Transformed via BoxCox, Lambda = ', lmbda, sep=""))
#Reset to 1, not going to use it.
lmbda <- 1
```

#Remove highly correlated pairs
```{r warning=FALSE}
cbecs_elbtu_encoded_df <- cbecs_el_encoded_df %>% 
  #remove zero variance variables
  select(-one_of(preProcess(., method = c('zv'))$method$remove)) %>% 
  #remove response columns
  select(-one_of(cbecs_dfs$response_cols)) %>%
  #remove pba
  #select(-matches('^PBA\\.')) %>% 
  select(-one_of(findCorrelation(cor(.), cutoff=0.75, names = TRUE))) %>%
  #remove remaining pba values then reinsert all
  #select(-matches('^PBAPLUS')) %>% 
  #bind_cols(cbecs_el_encoded_df %>% select(matches('^PBAPLUS'))) %>% 
  bind_cols(ELBTUPerSf = cbecs_el_encoded_df %>% select(ELBTUPerSf))

cbecs_elbtu_encoded_numerics_cols <- colnames(
  cbecs_elbtu_encoded_df %>% 
    select(one_of(cbecs_dfs$encoded_numeric_cols)) %>% 
    select(-ELBTUPerSf)) 
cbecs_elbtu_encoded_non_numerics_cols <- colnames(
  cbecs_elbtu_encoded_df %>% 
  select(one_of(cbecs_dfs$encoded_non_numeric_cols)))

#center and scale only numeric columns in data set, not encoder columns
elbtu_pre_process <- preProcess(
  cbecs_elbtu_encoded_df, 
  method = list(center = cbecs_elbtu_encoded_numerics_cols, 
       scale = cbecs_elbtu_encoded_numerics_cols))
cbecs_elbtu_encoded_center_scale_df <- predict(elbtu_pre_process, cbecs_elbtu_encoded_df)
```

#Set number of most important variables to take from each model
```{r}
top_n_rows <- 20
```

#PCA
```{r fig.width=10}
cbecs_pca <- prcomp(cbecs_elbtu_encoded_center_scale_df %>% 
    select(-ELBTUPerSf) %>%
    select(-one_of(cbecs_dfs$response_cols)), center = TRUE, scale. = TRUE)
p1 <- fviz_eig(cbecs_pca, addlabels = TRUE)
var <- get_pca_var(cbecs_pca)
p2 <- fviz_pca_var(cbecs_pca, select.var = list(contrib=20), repel = TRUE)
p3 <- fviz_contrib(cbecs_pca, choice = "var", axes = 1:20, top = 20)
pca_imp_df <- fviz_contrib(cbecs_pca, choice = "var", axes = 1:20, top = 50)$data %>% 
  arrange(desc(contrib)) %>% 
  head(top_n_rows) %>% 
  select(name) %>% 
  rename(feature = name) %>% 
  mutate(feature = as.character(feature))
grid.arrange(p1, p3, nrow=1)
g <- arrangeGrob(p1, p3, nrow = 1)
ggsave('Documents/Images/electricity_pca_vars.png', g, width = 6.5, height = 3, units = 'in')
```

<<<<<<< HEAD
=======
#save model
```{r}
save(cbecs_pca, file = 'ModelSaves/elbtu_pca.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
```{r}
#ggplot(cbecs_dfs$clean_df, aes(x=COOK, y=log(ELBTUPerSf))) + geom_boxplot()
#ggplot(cbecs_dfs$clean_df, aes(x=LAUNDR, y=log(ELBTUPerSf))) + geom_boxplot()
#ggplot(cbecs_dfs$clean_df, aes(x=CUBE, y=log(ELBTUPerSf))) + geom_boxplot()
#ggplot(cbecs_dfs$clean_df, aes(x=ELCPLT, y=(ELBTUPerSf))) + geom_boxplot()
#ggplot(cbecs_dfs$clean_df, aes(x=BLDPLT, y=(ELBTUPerSf))) + geom_boxplot()
```

<<<<<<< HEAD

=======
>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#Train/Test split
```{r}
cbecs_train_list <- createDataPartition(y= cbecs_el_cleaned_df$PBAPLUS, p=0.8, list = FALSE) 
cbecs_elbtu_encoded_train_df <- cbecs_elbtu_encoded_df[cbecs_train_list,]
cbecs_elbtu_encoded_test_df <- cbecs_elbtu_encoded_df[-cbecs_train_list,]
cbecs_elbtu_encoded_center_scale_train_df <- cbecs_elbtu_encoded_center_scale_df[cbecs_train_list,]
cbecs_elbtu_encoded_center_scale_test_df <- cbecs_elbtu_encoded_center_scale_df[-cbecs_train_list,]
#stratify training set
<<<<<<< HEAD
folds <- 5
=======
folds <- 2
>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
cbecs_train_cv_list <- createFolds(y=cbecs_el_cleaned_df[cbecs_train_list,]$PBAPLUS, k = folds, returnTrain = TRUE)
```

#PLS 
```{r fig.height=8}
lmbda <- 1
control <- trainControl(index = cbecs_train_cv_list, 
                        method = 'repeatedcv', 
                        number = folds, 
                        repeats = 1, 
                        search = 'grid', 
                        verboseIter = TRUE)
tunegrid <- expand.grid(ncomp = seq(1, 10, 1))
pls_train <- caret::train(
  y = cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf^lmbda,
  x = cbecs_elbtu_encoded_center_scale_train_df %>% select(-ELBTUPerSf),
  method='pls',
  metric='RMSE',
  tuneGrid=tunegrid,
  trControl=control
)
print(pls_train)
varImp(pls_train)
pls_plot <- plot_fun(in_model=pls_train, n_features=top_n_rows, short_name='pls', alt_predict = TRUE)
pls_plot$vars_plot
plot(pls_plot$tmp_model)
pls_imp_df <- pls_plot$imp_df
```

<<<<<<< HEAD
=======
#save model
```{r}
save(pls_train, file = 'ModelSaves/elbtu_pls.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#Plots
```{r}
#ggplot(cbecs_elbtu_encoded_center_scale_df, aes(x=((RFGWINPerSf)), y=(ELBTUPerSf)^lmbda)) + geom_point()
#ggplot(cbecs_elbtu_encoded_center_scale_df, aes(x=((RGSTRNPerSf)), y=(ELBTUPerSf)^lmbda)) + geom_point()
```

#Tree regression importance
```{r fig.height=10}
#eval set to false, takes a long time to process
control <- trainControl(index = cbecs_train_cv_list, 
                        method = 'repeatedcv', 
                        number = folds, 
                        repeats = 1, 
                        search = 'grid', 
                        verboseIter = TRUE)
tunegrid <- expand.grid(mtry = seq(50, 550, 100))
rf_train <- caret::train(
  y = cbecs_elbtu_encoded_train_df$ELBTUPerSf,
  x = cbecs_elbtu_encoded_train_df %>% select(-ELBTUPerSf),
  method='rf',
  metric='RMSE',
  tuneGrid=tunegrid,
  trControl=control,
  maxnodes=100,
  importance = TRUE
)
print(rf_train)
varImp(rf_train)
rf_plot <- plot_fun(in_model=rf_train, n_features=top_n_rows, short_name='rf')
rf_plot$vars_plot
plot(rf_plot$tmp_model)
rf_imp_df <- rf_plot$imp_df
```

<<<<<<< HEAD
=======
#save model
```{r}
save(rf_train, file = 'ModelSaves/elbtu_rf.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
lasso
```{r eval=FALSE}
control <- trainControl(index = cbecs_train_cv_list, 
                        method = 'repeatedcv', 
                        number = folds, 
                        repeats = 1, 
                        search = 'grid', 
                        verboseIter = TRUE)
tunegrid <- expand.grid(fraction = seq(0.4, 0.5, .1))
l_train <- caret::train(
  y = cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf,
  x = cbecs_elbtu_encoded_center_scale_train_df %>% select(-ELBTUPerSf),
  method='lasso',
  metric='RMSE',
  tuneGrid=tunegrid,
  trControl=control,
  preProcess = c('zv')#,
  #weights = 1 / (cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf^lmbda)
)
print(l_train)
varImp(l_train)
l_plot <- plot_fun(in_model=l_train, n_features=top_n_rows, short_name='l', alt_predict = TRUE)
l_plot$vars_plot
plot(l_plot$tmp_model)
l_imp_df <- l_plot$imp_df
```

<<<<<<< HEAD
=======
#save model
```{r}
save(l_train, file = 'ModelSaves/elbtu_l.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
leaps
```{r}
control <- trainControl(index = cbecs_train_cv_list, 
                        method = 'repeatedcv', 
                        number = folds, 
                        repeats = 1, 
                        search = 'grid', 
                        verboseIter = TRUE)
tunegrid <- expand.grid(nvmax = seq(10, 100, 10))
lp_train <- caret::train(
  y = cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf,
  x = cbecs_elbtu_encoded_center_scale_train_df %>% select(-ELBTUPerSf),
  method='leapForward',
  metric='RMSE',
  tuneGrid=tunegrid,
  trControl=control,
  preProcess = c('zv')
)
print(lp_train)
varImp(lp_train)
lp_plot <- plot_fun(in_model=lp_train, n_features=top_n_rows, short_name='lp', alt_predict = TRUE)
lp_plot$vars_plot
plot(lp_plot$tmp_model)
lp_imp_df <- lp_plot$imp_df
```

<<<<<<< HEAD
=======
#save model
```{r}
save(lp_train, file = 'ModelSaves/elbtu_lp.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#recursive feaure extraction
```{r}
ctrl <- rfeControl(functions = treebagFuncs,
                   index = cbecs_train_cv_list, 
                   method = 'repeatedcv', 
                   number = folds, 
                   repeats = 1,
                   verbose = TRUE)

rfe_train <- rfe(y = cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf,
                 x = cbecs_elbtu_encoded_center_scale_train_df %>% select(-ELBTUPerSf),
<<<<<<< HEAD
                 sizes = c(1:20, seq(50, 700, 50)),
=======
                 #sizes = c(1:20, seq(50, 700, 50)),
                 sizes = c(1:20, seq(500, 700, 50)),
>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
                 rfeControl = ctrl)

rfe_train
plot(rfe_train, type=c('g', 'o'))
rfe_imp_df <- rfe_train$variables %>% filter(Variables == 7) %>% select(var) %>% distinct() %>% rename(feature = var)
varImp(rfe_train)
```

<<<<<<< HEAD
=======
#save model
```{r}
save(rfe_train, file = 'ModelSaves/elbtu_rfe.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#Simple neural network training
```{r echo=FALSE, fig.width=10}
control <- trainControl(index = cbecs_train_cv_list, 
                        method = 'repeatedcv', 
                        number = folds, 
                        repeats = 1, 
                        search = 'grid')
tunegrid <- expand.grid(size = seq(10, 200, 10), 
                        dropout = seq(0.1, 0.9, 0.2), 
                        batch_size = seq(1000, 4000, 1000), 
                        lr = seq(0.1, 0.9, 0.2),
                        rho = seq(0.1, 0.9, 0.2),
                        decay = seq(0.1, 0.9, 0.2), 
                        activation = c('relu'))
nn_train <- caret::train(
  y = cbecs_elbtu_encoded_center_scale_train_df$ELBTUPerSf,
  x = cbecs_elbtu_encoded_center_scale_train_df %>% select(-ELBTUPerSf),
  method='mlpKerasDropout',
  metric='RMSE',
  tuneGrid=tunegrid,
  trControl=control,
  preProcess = c('zv')
)
print(nn_train)
varImp(nn_train)
nn_plot <- plot_fun(in_model=nn_train, n_features=top_n_rows, short_name='nn', alt_predict = TRUE)
nn_plot$vars_plot
plot(nn_plot$tmp_model)
nn_imp_df <- nn_plot$imp_df
```

<<<<<<< HEAD
=======
#save model
```{r}
save(nn_train, file = 'ModelSaves/elbtu_nn.RData')
```

#load models
```{r}
load('ModelSaves/elbtu_pca.RData')
load('ModelSaves/elbtu_pls.RData')
load('ModelSaves/elbtu_rf.RData')
load('ModelSaves/elbtu_l.RData')
load('ModelSaves/elbtu_lp.RData')
load('ModelSaves/elbtu_rfe.RData')
load('ModelSaves/elbtu_nn.RData')
```

>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#trained model summaries
```{r}
resamps <- resamples(list(
  pls_fit = pls_train,
  rf_fit = rf_train,
  lp_fit = lp_train,
  rfe_fit = rfe_train,
  nn_fit = nn_train
))
summary(resamps)
```

<<<<<<< HEAD

#make neural network input df based on the most important features selected
```{r}
nn_input_train_test_df <- cbecs_elbtu_encoded_center_scale_train_df %>% 
  select(one_of(pls_imp_df$feature), 
         one_of(pca_imp_df$feature),
         one_of(rf_imp_df$feature),
         one_of(nn_imp_df$feature),
         one_of(rfe_imp_df$feature),
         ELBTUPerSf
         #one_of(colnames(cbecs_elbtu_encoded_center_scale_df %>% select(matches('^PBAPLUS'))))
  )

nn_input_validate_df <- cbecs_elbtu_encoded_center_scale_test_df %>% 
  select(one_of(pls_imp_df$feature), 
         one_of(pca_imp_df$feature),
         one_of(rf_imp_df$feature),
         one_of(nn_imp_df$feature),
         one_of(rfe_imp_df$feature),
         ELBTUPerSf
         #one_of(colnames(cbecs_elbtu_encoded_center_scale_df %>% select(matches('^PBAPLUS'), ELBTUPerSf)))
  )
```



=======
>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#Save dataframes for full analysis
```{r}
nn_input_df <- cbecs_elbtu_encoded_center_scale_df %>% 
  select(one_of(pls_imp_df$feature), 
         one_of(pca_imp_df$feature),
         one_of(rf_imp_df$feature),
         one_of(nn_imp_df$feature),
         one_of(rfe_imp_df$feature),
         ELBTUPerSf
         #one_of(colnames(cbecs_elbtu_encoded_center_scale_df %>% select(matches('^PBAPLUS'))))
  )

nn_input_pba_labels <- cbecs_el_cleaned_df$PBAPLUS
  
save(nn_input_pba_labels, 
     nn_input_df, 
     elbtu_pre_process,
<<<<<<< HEAD
=======
     cbecs_elbtu_encoded_center_scale_df,
>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
     file='nn_elbtu_input.RData'
)
```

<<<<<<< HEAD


=======
>>>>>>> 3cb970c39f2115dae15235ea0999d4d9975d8f60
#Stop parallel processing
```{r}
stopCluster(cl)
```

