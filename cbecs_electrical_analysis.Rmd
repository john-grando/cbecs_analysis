---
title: "cbecs_electrical_analysis"
author: "John Grando"
date: "February 11, 2019"
output: html_document
---

Source files
```{r}
source('tree_func.R')
source('cbecs_2012_clean_transform.R')
```

Libraries
```{r}

```

Load and transform
```{r}
cbecs_raw_df <- read.csv('./2012_public_use_data_aug2016.csv', 
                         header = TRUE, 
                         stringsAsFactors = FALSE)
cbecs_dfs <- clean_encode_cbecs(cbecs_raw_df)
```

### Explore


Response Variable
```{r}
lmbda <- BoxCoxTrans(cbecs_dfs$clean_df$ELBTUPerSf + 1)$lambda
ggplot(cbecs_dfs$clean_df, aes(x=ELBTUPerSf^lmbda)) + 
  geom_density() + 
  stat_function(fun=dnorm,
                color="blue",
                args=list(
                  mean=mean(cbecs_dfs$clean_df$ELBTUPerSf^lmbda, na.rm = TRUE),
                  sd(cbecs_dfs$clean_df$ELBTUPerSf^lmbda, na.rm = TRUE)
                )
  ) +
  ggtitle(paste('ELBTUPerSf Transformed via BoxCox, Lambda = ', lmbda, sep=""))
```


PCA
```{r fig.width=20}
cbecs_pca <- prcomp(cbecs_dfs$encoded_df %>%
    select(-one_of(cbecs_dfs$response_cols)), center = TRUE, scale. = TRUE)
screeplot(cbecs_pca, type = 'lines', npcs = 20)
var <- get_pca_var(cbecs_pca)
fviz_pca_ind(cbecs_pca,
             geom.ind = 'point',
             col.ind = factor(
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[2]], 0, 
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[3]], 1,
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[4]], 2,
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[5]], 3,
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[6]], 4,
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[7]], 5,
               ifelse(cbecs_dfs$encoded_df$ELBTUPerSf < quantile(cbecs_dfs$encoded_df$ELBTUPerSf, probs = seq(0, 1, 0.1))[[8]], 6,7)))))))
             ),
             addEllipses = TRUE)
```

#Tree regression importance
```{r fig.height=10}
cbecs_pbaplus_df <- cbecs_dfs$clean_df %>% 
  select(-one_of(cbecs_dfs$response_cols)) %>% 
  bind_cols(ELBTUPerSf = cbecs_dfs$clean_df$ELBTUPerSf)
cbecs_pbaplus_rf <- randomForest(ELBTUPerSf ~ ., 
                              data = cbecs_pbaplus_df,
                              ntree = 100,
                              maxnodes = 100
                  )
varImpPlot(cbecs_pbaplus_rf, n.var = 50)
```

Remove highly correlated pairs and report???
```{r}
cbecs_elbtu_df <- cbecs_dfs$encoded_df %>% 
  select(-one_of(cbecs_dfs$response_cols)) %>% 
  select(findCorrelation(cor(.), cutoff=0.75, names = TRUE)) %>% 
  bind_cols(ELBTUPerSf = cbecs_dfs$encoded_df[,c('ELBTUPerSf')])
```

```{r fig.height=14}
library(pls)
control <- trainControl(method = 'repeatedcv', number = 8, repeats = 3, search = 'grid')
tunegrid <- expand.grid(ncomp = seq(10, 60, 2))
pls_train <- train(
  ELBTUPerSf^0.2 ~ .,
  data=cbecs_elbtu_df,
  method='pls',
  metric='Rsquared',
  tuneGrid=tunegrid,
  trControl=control,
  preProcess = c("center", "scale")
)
print(pls_train)
ggplot(cbecs_elbtu_df, 
       aes(x=pls_train$finalModel$fitted.values[,,26]^(1/0.2), 
           y=ELBTUPerSf)) + geom_point()
plot(varImp(pls_train), 40)
```

Leaps???
```{r}
library(leaps)
```

