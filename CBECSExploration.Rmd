---
title: "CBECS Exploration"
author: "John Grando"
date: "January 29, 2019"
output: html_document
---

```{r echo=FALSE}
library(dplyr)
library(tidyr)
library(kableExtra)
library(gridExtra)
library(ggplot2)
library(randomForest)
library(corrplot)
library(caret)
library(cluster)
library(factoextra)
library(e1071)
library(ggfortify)
```

```{r}
source('tree_func.R')
source('cbecs_2012_clean_transform.R')
```


```{r}
cbecs_raw_df <- read.csv('./2012_public_use_data_aug2016.csv', 
                         header = TRUE, 
                         stringsAsFactors = FALSE)
cbecs_dfs <- clean_transform_cbecs(cbecs_raw_df)
```


#Explore data set. response variable shapes, correlations, k-means clustering, princomp, etc. to determine possibility of prediction.

```{r fig.width=6, fig.height=5}
#histograms of possible response categories
cbecs_response_df <- cbecs_dfs$trans_df %>% 
  select(ELBTUPerSf, NGBTUPerSf, DHBTUPerSf, FKBTUPerSf, MFBTUPerSf) %>% 
  gather("source", "BTU", 1:5)
p1 <- ggplot(cbecs_response_df %>% filter(source=='ELBTUPerSf' & BTU > 0), aes(x=BTU)) + 
  geom_histogram(bins = 40) + 
  ggtitle('Electric') +
  labs(x = 'BTU Per SF', y='') +
  theme(plot.title = element_text(hjust = 0.5, size=10),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=8, color = "grey55"), 
        axis.title = element_text(size=10, color = "grey55"),
        axis.title.y = element_text(size = 0))
p2 <- ggplot(cbecs_response_df %>% filter(source=='NGBTUPerSf' & BTU > 0), aes(x=BTU)) + 
  geom_histogram(bins = 40) + 
  ggtitle('Nat. Gas') +
  labs(x = 'BTU Per SF', y='') +
  theme(plot.title = element_text(hjust = 0.5, size=10),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=8, color = "grey55"), 
        axis.title = element_text(size=10, color = "grey55"),
        axis.title.y = element_text(size = 0))
p3 <- ggplot(cbecs_response_df %>% filter(source=='DHBTUPerSf' & BTU > 0), aes(x=BTU))+ 
  geom_histogram(bins = 40) + 
  ggtitle('District Heat') +
  labs(x = 'BTU Per SF', y='') +
  theme(plot.title = element_text(hjust = 0.5, size=10),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=8, color = "grey55"), 
        axis.title = element_text(size=10, color = "grey55"),
        axis.title.y = element_text(size = 0))
p4 <- ggplot(cbecs_response_df %>% filter(source=='FKBTUPerSf' & BTU > 0), aes(x=BTU)) + 
  geom_histogram(bins = 40) + 
  ggtitle('Fuel Oil') +
  labs(x = 'BTU Per SF', y='') +
  theme(plot.title = element_text(hjust = 0.5, size=10),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=8, color = "grey55"), 
        axis.title = element_text(size=10, color = "grey55"),
        axis.title.y = element_text(size = 0))
p5 <- ggplot(cbecs_response_df %>% filter(source=='MFBTUPerSf' & BTU > 0), aes(x=BTU)) + 
  geom_histogram(bins = 40) + 
  ggtitle('All Major Fuel') +
  labs(x = 'BTU Per SF', y='') +
  theme(plot.title = element_text(hjust = 0.5, size=10),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=8, color = "grey55"), 
        axis.title = element_text(size=10, color = "grey55"),
        axis.title.y = element_text(size = 1))
lay <- rbind(
  c(1, 2),
  c(3, 4),
  c(5, 5)
)
tmp_plot <- grid.arrange(top = "Consumption By Major Fuel", 
                         p1, p2, p3, p4, p5, 
                         ncol=2,
                         layout_matrix=lay
)
ggsave('Documents/major_fuels_preliminary_analysis.png', tmp_plot)
tmp_plot
```

# Correlation plot
```{r fig.width=40}
cbecs_clean_scaled_df <- scale(
  cbecs_clean_df %>%
    select(one_of(removed_response_list)) %>% 
    select(one_of(cbecs_clean_numeric_cols)) %>% 
    select(-matches('.*USED$'))
)
correlations_df <- cor(cbecs_clean_scaled_df)
corrplot(correlations_df)
```

#k means
```{r fig.height=8}
kmeans_fit <- kmeans(cbecs_clean_scaled_df, centers=3, nstart = 25)
fviz_cluster(kmeans_fit, data=cbecs_clean_scaled_df) + 
  ggtitle('K Means Cluster Analysis') +
  theme(plot.title = element_text(hjust = 0.5, size=20),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=10, color = "grey55"), 
        axis.title = element_text(size=14, color = "grey55"))
ggsave('Documents/k_means_preliminary.png')
ggplot(data=cbind(cbecs_clean_df, kgroup = kmeans_fit$cluster), aes(x=log(MFBTUPerSf/WKHRS), y=log(SERVERNPerSf), color=as.factor(kgroup), shape=as.factor(kgroup))) + geom_point(aes(alpha=0.4)) + facet_wrap(~factor(ifelse(RFGWINPerSf>0|RFGCLNPerSf>0|RGSTRNPerSf,1,0)), scales = 'free')

```


#PCA
```{r fig.width=8}
cbecs_pca <- prcomp(cbecs_clean_df %>%
    select(one_of(removed_response_list)) %>% 
    select(one_of(cbecs_clean_numeric_cols))%>% 
    select(-matches('.*USED$')), 
                    center = TRUE, 
                    scale. = TRUE)
screeplot(cbecs_pca, type = 'lines')
summary(cbecs_pca)
ggplot(cbecs_pca$x, aes(x=PC1, y=PC2, color=cbecs_clean_df$PBA)) + geom_point() + geom_text(aes(label=cbecs_clean_df$PBAPLUS), nudge_x = 0.5) +
  ggtitle('Principal Component Analysis - Group IDs') +
  theme(plot.title = element_text(hjust = 0.5, size=20),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=10, color = "grey55"), 
        axis.title = element_text(size=14, color = "grey55"),
        legend.position = 'none')
ggsave('Documents/pca_group_ids_preliminary.png')
autoplot(cbecs_pca, data = cbecs_clean_df, loadings=TRUE, loadings.label = TRUE, alpha=0.2, loadings.label.size = 3) +
  ggtitle('Principal Component Analysis - Vectors') +
  theme(plot.title = element_text(hjust = 0.5, size=20),
        strip.text = element_text(size = 20),
        plot.background = element_rect(fill = "lightgrey"), 
        panel.background = element_rect(fill = "white"), 
        panel.grid.major.x = element_line(color = "lightgrey"), 
        panel.grid.major.y = element_line(color = "lightgrey"), 
        axis.text = element_text(size=10, color = "grey55"), 
        axis.title = element_text(size=14, color = "grey55"))
ggsave('Documents/pca_group_vectors_preliminary.png')


#additional charts
cbecs_pca <- prcomp(cbecs_dfs$encoded_df %>%
    select(-one_of(cbecs_dfs$response_cols)), center = TRUE, scale. = TRUE)
screeplot(cbecs_pca, type = 'lines', npcs = 20)
var <- get_pca_var(cbecs_pca)
fviz_contrib(cbecs_pca, choice = 'var', axes = 1:7, top = 50)
```


#Remove collinear, and other possible response variable, columns and create df for prediction for just electricity
```{r}
elbtu_pred_list <- append(
  removed_response_list,
  'ELBTUPerSf')
cbecs_elbtu_df <- cbecs_clean_df %>% 
  select_(.dots = elbtu_pred_list) %>% 
  na.omit()
```

```{r}
#split train/test

```

#Random Forest
```{r fig.height=10}
cbecs_pbaplus_df <- cbecs_clean_df %>% 
  select(-PBA) %>% 
  select(one_of(removed_response_list))
cbecs_pbaplus_rf <- randomForest(PBAPLUS ~ ., 
                              data = cbecs_pbaplus_df,
                              ntree = 100,
                              maxnodes = 100
                  )
varImpPlot(cbecs_pbaplus_rf)

#set up training/tuning parameters - examples in caret - https://machinelearningmastery.com/tune-machine-learning-algorithms-in-r/
```

```{r fig.width=30}
tree_func(cbecs_pbaplus_rf, 1)
```


```{r fig.height=10}

tst <- cbecs_pbaplus_df %>% bind_cols(PBAPLUSPred = predict(cbecs_pbaplus_rf, newdata=cbecs_pbaplus_df))
ggplot(tst, aes(PBAPLUSPred, ..count..)) + geom_bar() + facet_wrap(~PBAPLUS, scales = "free")
data.frame(error = cbecs_pbaplus_rf$confusion[,'class.error']) %>% add_rownames(var="PBAPLUS") %>% arrange(desc(error))
```

#svm
```{r eval=FALSE}
#Takes a long time, only run when needed
svm_fit <- svm(PBA ~ ., 
               data = cbind(cbecs_clean_df[, cbecs_clean_numeric_cols], PBA = cbecs_clean_df$PBA), 
               kernel='linear', 
               cost=10, 
               scale=FALSE, 
               cachesize=2000)
plot(svm_fit, data = cbecs_clean_df, ELBTUPerSf ~ CDD65)
plot(svm_fit, data = cbecs_clean_df, log(NGBTUPerSf + 1) ~ HDD65)
```